{% load jinja_filters %}
{% load static %}

<div class="form-wrapper" id="{{ uniqueid }}">
    <div class="remove-form" style="color:red; cursor:pointer;">Ø­Ø°Ù</div>
    <div class="col-sm-6 col-xl-3">
        {{ form_balance.user }}
        <div class="mb-0">
        {{ form_balance.account }}

        <button type="button"
            class="btn btn-sm btn-light-secondary" data-bs-toggle="modal"
            data-bs-target="#{{ uniqueid }}-accounts-lists"
            id="{{ uniqueid }}-accounts-list-btn">
            <i class="ph-duotone ph-pencil-simple-line"></i> ØªØºÛŒÛŒØ±
        </button>
            </div>
        <h5 id="{{ uniqueid }}-accounts-list"></h5>
        <input type="hidden" id="{{ uniqueid }}-selected-account-id">
        <div class="modal fade" id="{{ uniqueid }}-accounts-lists" data-bs-keyboard="false" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                            <h5 class="mb-0">Ø§Ù†ØªØ®Ø§Ø¨ Ø­Ø³Ø§Ø¨</h5>
                    </div>
                    <div class="modal-body">
                    </div>
                    <div class="modal-footer justify-content-between collapse multi-collapse show">
                        <div class="flex-grow-1 text-end">
                            <button type="button" class="btn btn-link-danger" data-bs-dismiss="modal">Ù„ØºÙˆ</button>
                            <button type="button" id="select-account-{{ uniqueid }}" class="btn btn-primary" data-bs-dismiss="modal">Ø°Ø®ÛŒØ±Ù‡</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
    {{ form_balance.transaction_type }}
    <div class="cashonly input-group mb-3">
        <div class="input-group mb-3">
            <span class="input-group-text">{{ form_balance.amount.label }}</span>
            {{ form_balance.amount }}
        </div>
    </div>
    <div class="mb-0">
        <div class="form-control">{{ form_balance.description }}</div>
    </div>
    <div class="mb-3">
        <label class="form-label">{{ i.form_balance.image.label }}</label>
        {% if i.form_balance.image.value %}
            <img src="{{ i.form_balance.image.value.url }}" width="150px">
        {% endif %}
        {{ i.form_balance.image }}

    </div>
    <label>
        <input type="checkbox" class="toggle-cheque-form" />
        Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú†Ú©
    </label>
    <div class="cheque-form border rounded p-3 h-100 text-white bg-info" style="display: {% if i.form_cheque.name.value == None %}none{% else %}block{% endif %}; margin-top: 10px;">
        {{ form_cheque }}
    </div>
</div>
<script>
function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}
$(document).ready(function () {

    function getCSRFToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }

    let currentAction = null;
    let currentNodeId = null;

    function loadTree() {
        $.getJSON("{% url 'get_accounts_list' %}", function (response) {
            const tree = $('#accounts_tree').jstree(true);
            if (tree) {
                tree.settings.core.data = response.data;
                tree.refresh(true);
            } else {
                createTree(response.data);
            }
        });
    }

    function createTree(data) {
        $('#accounts_tree').jstree({
            core: {
                data: data,
                check_callback: true,
                themes: { stripes: true }
            },
            plugins: ['wholerow']
        }).on('ready.jstree refresh.jstree open_node.jstree', function () {
            addControlsToNodes();
        });
    }

    function addControlsToNodes() {
        const tree = $('#accounts_tree').jstree(true);
        const nodes = tree.get_json('#', { flat: true });

        nodes.forEach(node => {
            const nodeId = node.id;
            const realId = node.original?.real_id || node.id;
            const $anchor = $(`#${nodeId}_anchor`);

            if (!$anchor.hasClass('editing') && $anchor.find('.btn-edit').length === 0) {
            const $buttons = $('<span class="ms-auto">')
                .append(`<button type="button" class="btn btn-sm btn-edit" data-id="${realId}">ğŸ“</button>`)
                .append(`<button type="button" class="btn btn-sm btn-delete" data-id="${realId}">ğŸ—‘</button>`)
                .append(`<button type="button" class="btn btn-sm btn-add-child" data-id="${realId}">â•</button>`);

            $anchor.append($buttons);
            
            }
        });
    }
function renameAccountNode(nodeId, newText) {

       $("select[id*='balance-account']").each(function () {
        $(this).find(`option[value='${nodeId}']`).text(newText);
    });
}
$(document).on('click', '.btn-edit, .btn-add-child', function () {
    const $btn = $(this);
    const isEdit = $btn.hasClass('btn-edit');
    const nodeId = $btn.data('id');
    const $node = $(`#${nodeId}`);
    
    // Ø§Ú¯Ù‡ ÙØ±Ù… Ù‚Ø¨Ù„Ø§Ù‹ Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ØŒ Ø¯ÛŒÚ¯Ù‡ ØªÚ©Ø±Ø§Ø± Ù†Ú©Ù†
    if ($node.find('.node-form-container').length) return;

    // Ù…ØªÙ† ÙØ¹Ù„ÛŒ Ú¯Ø±Ù‡
    const $anchor = $(`#${nodeId}_anchor`);
    const currentText = isEdit ? $anchor.clone().children().remove().end().text().trim() : '';

    // ÙØ±Ù… Ø±Ùˆ Ø¨Ø³Ø§Ø²
    const $input = $('<input>', {
        type: 'text',
        class: 'form-control form-control-sm me-2 d-inline-block',
        value: currentText,
        style: 'width: 60%; max-width: 250px;'
    });

    const $save = $('<button>', {
        type: 'button',
        class: 'btn btn-sm btn-success me-1',
        html: 'ğŸ’¾'
    });

    const $cancel = $('<button>', {
        type: 'button',
        class: 'btn btn-sm btn-outline-secondary',
        html: 'âŒ'
    });

    const $form = $('<div class="node-form-container mt-1 d-flex align-items-center">')
        .append($input, $save, $cancel);

    $node.append($form);

    $cancel.click(() => $form.remove());

    $save.click(function () {
        const name = $input.val().trim();
        if (!name) return alert('Ù†Ø§Ù… Ù†Ø¨Ø§ÛŒØ¯ Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯!');
        const csrf = getCSRFToken();

        if (isEdit) {
            $.post("{% url 'edit_account' pk=0 %}".replace('0', nodeId), {
                name,
                csrfmiddlewaretoken: csrf
            }, function (res) {
                if (res.success){ 
                    loadTree();
                    renameAccountNode(nodeId ,name);
                }
                else alert(res.error || 'Ø®Ø·Ø§ Ø¯Ø± ÙˆÛŒØ±Ø§ÛŒØ´');
            });
        } else {
            $.post("{% url 'create_accounts' %}", {
                name,
                parent: nodeId,
                csrfmiddlewaretoken: csrf
            }, function (res) {
                if (res.success) loadTree();
                else alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† Ø­Ø³Ø§Ø¨');
            });
        }
    });
});

function deleteAccountNode(nodeIdToDelete) {
        $("select[id*='balance-account']").each(function () {
        $(this).find(`option[value='${nodeIdToDelete}']`).remove();
    });
}

$(document).on('click', '.btn-delete', function () {
    const nodeId = $(this).data('id');

    Swal.fire({
        title: 'Ø­Ø°Ù Ø­Ø³Ø§Ø¨ØŸ',
        text: 'Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ Ø§ÛŒÙ† Ø¹Ù…Ù„ÛŒØ§Øª Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ³Øª!',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Ø¨Ù„Ù‡ØŒ Ø­Ø°Ù Ú©Ù†',
        cancelButtonText: 'Ø§Ù†ØµØ±Ø§Ù'
    }).then((result) => {
        if (result.isConfirmed) {
            $.post("{% url 'delete_account' pk=0 %}".replace('0', nodeId), {
                csrfmiddlewaretoken: getCSRFToken()
            }, function (res) {
                if (res.success) {
                    deleteAccountNode(nodeId);
                    loadTree();
                    Swal.fire('Ø­Ø°Ù Ø´Ø¯!', 'Ø­Ø³Ø§Ø¨ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯.', 'success');
                } else {
                    Swal.fire('Ø®Ø·Ø§', res.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø­Ø³Ø§Ø¨', 'error');
                }
            });
        }
    });
});


$(document).on('click', '#add_root_btn', function () {
    // Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ ÙØ±Ù… Ù‚Ø¨Ù„ÛŒ
    if ($('#new_root_input_row').length) return;

    const $input = $('<input>', {
        type: 'text',
        id: 'new_root_input',
        class: 'form-control form-control-sm me-2 d-inline-block',
        placeholder: 'Ù†Ø§Ù… Ø­Ø³Ø§Ø¨ Ø±ÛŒØ´Ù‡â€ŒØ§ÛŒ',
        style: 'width: 60%; max-width: 250px;'
    });

    const $save = $('<button>', {
        type: 'button',
        class: 'btn btn-sm btn-success me-1',
        html: 'ğŸ’¾'
    });

    const $cancel = $('<button>', {
        type: 'button',
        class: 'btn btn-sm btn-outline-secondary',
        html: 'âŒ'
    });

    const $row = $('<div id="new_root_input_row" class="mb-2 d-flex align-items-center">')
        .append($input, $save, $cancel);

    // ÙØ±Ù… Ø±Ùˆ Ø¨Ø¹Ø¯ Ø§Ø² Ø¯Ú©Ù…Ù‡ Ù‚Ø±Ø§Ø± Ø¨Ø¯Ù‡
    $('#add_root_btn').after($row);

    // Ø¨Ø³ØªÙ† ÙØ±Ù…
    $cancel.click(() => $row.remove());

    // Ø°Ø®ÛŒØ±Ù‡
    $save.click(function () {
        const name = $input.val().trim();
        if (!name) return alert('Ù†Ø§Ù… Ù†Ø¨Ø§ÛŒØ¯ Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯!');

        $.post("{% url 'create_accounts' %}", {
            name,
            csrfmiddlewaretoken: getCSRFToken()
        }, function (res) {
            if (res.success) {
                $row.remove();
                loadTree();
            } else {
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† Ø­Ø³Ø§Ø¨');
            }
        });
    });
});

    $('#{{ uniqueid }}-accounts-list-btn').click(function () {
        $.ajax({
            url: "{% url 'get_accounts_list' %}",
            type: "GET",
            success: function (response) {
                $('#{{ uniqueid }}-accounts-lists .modal-body').html(response.form_html);
                createTree(response.data);
            }
        });

        {#const modal = new bootstrap.Modal(document.getElementById('{{ uniqueid }}-accounts-lists'));#}
        {#modal.show();#}
    });

});
function handleAccountSelection(uniqueid) {
    const tree = $('#accounts_tree').jstree(true);
    const selectedIds = tree.get_selected();
    

    if (!selectedIds.length) {
        alert('Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ø­Ø³Ø§Ø¨ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.');
        return;
    }

    const selectedNode = tree.get_node(selectedIds[0]);
    const nodeId = selectedNode.original.real_id || selectedNode.id;
    const nodeText = selectedNode.text;

    // Ù†Ù…Ø§ÛŒØ´ Ù…Ù‚Ø¯Ø§Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ Ø¯Ø± Ú©Ù†Ø§Ø± Ø¯Ú©Ù…Ù‡
    $(`#${uniqueid}-selected-account-id`).val(nodeId);
    $(`#${uniqueid}-accounts-list`).text(nodeText);

    // ÙÙ‚Ø· select Ù‡Ø§ÛŒÛŒ Ú©Ù‡ Ø¢ÛŒØ¯ÛŒâ€ŒØ´ÙˆÙ† Ø´Ø¨ÛŒÙ‡ balance-account Ù‡Ø³Øª
    const $accountSelect = $(`#id_${uniqueid}-new-balance-account, #id_${uniqueid}-update-balance-account`);

    if ($accountSelect.length && $accountSelect.is('select')) {
        let $existingOption = $accountSelect.find(`option[value="${nodeId}"]`);

        if ($existingOption.length > 0) {
            // Ø§Ú¯Ø± Ú¯Ø²ÛŒÙ†Ù‡ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯ ÙÙ‚Ø· Ù…ØªÙ†Ø´ Ø±Ø§ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú©Ù†
            $existingOption.text(nodeText);
        } else {
            // Ø¯Ø± ØºÛŒØ± Ø§ÛŒÙ† ØµÙˆØ±Øª Ú¯Ø²ÛŒÙ†Ù‡ Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†
            $accountSelect.append(`<option value="${nodeId}">${nodeText}</option>`);
        }

        // Ù…Ù‚Ø¯Ø§Ø± Ø±Ø§ Ø³Øª Ú©Ù†
        $accountSelect.val(nodeId).trigger('change');
    }
}

// Ø¯Ú©Ù…Ù‡ select-account- Ø±Ø§ ÙˆØµÙ„ Ú©Ù†
$(document).on('click', "[id^='select-account-']", function () {
    const uniqueid = this.id.replace('select-account-', '');
    handleAccountSelection(uniqueid);
});



</script>
<script type="text/javascript" src="{% static 'js/chrome-cancell-input.js' %}"></script>
