{% extends 'base.html' %}
{% load static %}
{% load jinja_filters %}
{% block header %}
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <link type="text/css" rel="stylesheet" href="{% static 'js/jalalidatepicker.min.css' %}" />
    <script type="text/javascript" src="{% static 'js/jalalidatepicker.min.js' %}"></script>



{% endblock %}

{% block body %}
<div>
    <h2>گزارش چک ها</h2>
    
    <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="pills-debit-tab" data-bs-toggle="pill" data-bs-target="#debits" type="button" role="tab" aria-controls="pills-debit" aria-selected="true">دریافتنی</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="pills-credit-tab" data-bs-toggle="pill" data-bs-target="#credits" type="button" role="tab" aria-controls="pills-credit" aria-selected="false">پرداختنی</button>
    </li>
    </ul>
    <div class="tab-content" id="pills-tabContent">
    
        <div id="debits" class="tab-pane fade show active" id="pills-debit" role="tabpanel" aria-labelledby="pills-debit-tab" tabindex="0">
            <form id="debit-filter-form">
                <div class="row mb-3 p-3 rounded" style="background-color: #e7f7ec;"> 
                    <div class="col-md-3 mb-2">
                                <input type="text" name="cheque_name" placeholder="جستجو نام چک" class="form-control mb-2">
                            </div>
                    <div class="col-md-3 mb-2">
                                <input type="text" name="description" placeholder="جستجو در توضیحات" class="form-control mb-2">
                            </div>
                            <div class="col-md-3 mb-2">
                            <input type="text" name="amount" placeholder="مبلغ سررسید" class="form-control mb-2">
                            </div>
                            <div class="col-md-3 mb-2">
                            <select class="form-select" id="inputGroupSelect04" aria-label="Example select with button addon" name="cheque_status">
                                <option value="">همه وضعیت‌ها</option>
                                <option value="جاری">جاری</option>
                                <option value="عودتی">عودتی</option>
                                <option value="وصولی">وصولی</option>
                                <option value="برگشتنی">برگشتنی</option>
                                <option value="امانی">امانی</option>
                            </select>
                            </div>
                </div>
                                        <!-- بخش اول: تاریخ ثبت -->
                <div class="row mb-3 p-3 rounded" style="background-color: #e8f0fe;">
                    <label class="mb-2 fw-bold">تاریخ ثبت:</label>
                    <div class="col-md-6 mb-2">
                        <input type="text" class="form-control" name="created_at_from" data-jdp placeholder="تاریخ ثبت از">
                    </div>
                    <div class="col-md-6 mb-2">
                        <input type="text" class="form-control" name="created_at_to" data-jdp placeholder="تاریخ ثبت تا">
                    </div>
                </div>
                                    <!-- بخش دوم: تاریخ سررسید -->
                <div class="row mb-3 p-3 rounded" style="background-color: #fef7e0;">
                    <label class="mb-2 fw-bold">تاریخ سررسید:</label>
                    <div class="col-md-6 mb-2">
                        <input type="text" class="form-control" name="due_date_from" data-jdp placeholder="تاریخ سررسید از">
                    </div>
                    <div class="col-md-6 mb-2">
                        <input type="text" class="form-control" name="due_date_to" data-jdp placeholder="تاریخ سررسید تا">
                    </div>
                </div>

            </form>
            
        <div id="debit-cheques-list">
                        {% include "partials/debit_cheques.html" %}

                        
        </div>
                    </div>
        <div id="credits" class="tab-pane fade show" id="pills-credit" role="tabpanel" aria-labelledby="pills-credit-tab" tabindex="0">
            <form id="credit-filter-form">
                <div class="row mb-3 p-3 rounded" style="background-color: #e7f7ec;"> 
                    <div class="col-md-3 mb-2">
                        <input type="text" name="cheque_name" placeholder="جستجو نام چک" class="form-control mb-2">
                    </div>
                    <div class="col-md-3 mb-2">
                        <input type="text" name="description" placeholder="جستجو در توضیحات" class="form-control mb-2">
                    </div>
                    <div class="col-md-3 mb-2">
                        <input type="text" name="amount" placeholder="مبلغ سررسید" class="form-control mb-2">
                    </div>
                    <div class="col-md-3 mb-2">
                        <select class="form-select" id="inputGroupSelect04" aria-label="Example select with button addon" name="cheque_status">
                            <option value="">همه وضعیت‌ها</option>
                            <option value="جاری">جاری</option>
                            <option value="عودتی">عودتی</option>
                            <option value="وصولی">وصولی</option>
                            <option value="برگشتنی">برگشتنی</option>
                            <option value="امانی">امانی</option>
                        </select>
                    </div>
                </div>
                                        <!-- بخش اول: تاریخ ثبت -->
                <div class="row mb-3 p-3 rounded" style="background-color: #e8f0fe;">
                    <label class="mb-2 fw-bold">تاریخ ثبت:</label>
                    <div class="col-md-6 mb-2">
                        <input type="text" class="form-control" name="created_at_from" data-jdp placeholder="تاریخ ثبت از">
                    </div>
                    <div class="col-md-6 mb-2">
                        <input type="text" class="form-control" name="created_at_to" data-jdp placeholder="تاریخ ثبت تا">
                    </div>
                </div>
                                    <!-- بخش دوم: تاریخ سررسید -->
                <div class="row mb-3 p-3 rounded" style="background-color: #fef7e0;">
                    <label class="mb-2 fw-bold">تاریخ سررسید:</label>
                    <div class="col-md-6 mb-2">
                        <input type="text" class="form-control" name="due_date_from" data-jdp placeholder="تاریخ سررسید از">
                    </div>
                    <div class="col-md-6 mb-2">
                        <input type="text" class="form-control" name="due_date_to" data-jdp placeholder="تاریخ سررسید تا">
                    </div>
                </div>

            </form>
            <div id="credit-cheques-list">

            {% include "partials/credit_cheques.html" %}

            
            </div>
        </div>
    </div>
    </div>
    <script src="{% static 'js/plugins/isotope.pkgd.min.js' %}"></script>
    <script src="{% static 'js/plugins/index.js' %}"></script>
    <script>
    jalaliDatepicker.startWatch();

$(document).ready(function () {

    function filterDebits() {
        let formData = $('#debit-filter-form').serializeArray();

        // حذف همه پارامترهای credit_* از URL
        const params = new URLSearchParams(window.location.search);
        [...params.keys()].forEach(k => {
            if (k.startsWith('credit_')) params.delete(k);
        });

        // اضافه کردن پارامترهای debit_ جدید
        formData.forEach(f => params.set('debit_' + f.name, f.value));

        const newUrl = window.location.pathname + '?' + params.toString();
        window.history.pushState({}, '', newUrl);

        $.ajax({
            url: "{% url 'filter_debit_cheques' %}",
            data: $('#debit-filter-form').serialize(),
            success: function (data) {
                $('#debit-cheques-list').html(data.html);
            }
        });
    }

    function filterCredits() {
        let formData = $('#credit-filter-form').serializeArray();

        // حذف همه پارامترهای debit_* از URL
        const params = new URLSearchParams(window.location.search);
        [...params.keys()].forEach(k => {
            if (k.startsWith('debit_')) params.delete(k);
        });

        // اضافه کردن پارامترهای credit_ جدید
        formData.forEach(f => params.set('credit_' + f.name, f.value));

        const newUrl = window.location.pathname + '?' + params.toString();
        window.history.pushState({}, '', newUrl);

        $.ajax({
            url: "{% url 'filter_credit_cheques' %}",
            data: $('#credit-filter-form').serialize(),
            success: function (data) {
                $('#credit-cheques-list').html(data.html);
            }
        });
    }

    // پر کردن فرم‌ها از روی URL
    function fillFormsFromUrl() {
        const params = new URLSearchParams(window.location.search);
        params.forEach(function (value, key) {
            if (key.startsWith('debit_')) {
                let field = $(`#debit-filter-form [name="${key.replace('debit_', '')}"]`);
                if (field.attr('type') === 'checkbox' || field.attr('type') === 'radio') {
                    field.filter(`[value="${value}"]`).prop('checked', true);
                } else {
                    field.val(value).trigger('change');
                }
            }
            if (key.startsWith('credit_')) {
                let field = $(`#credit-filter-form [name="${key.replace('credit_', '')}"]`);
                if (field.attr('type') === 'checkbox' || field.attr('type') === 'radio') {
                    field.filter(`[value="${value}"]`).prop('checked', true);
                } else {
                    field.val(value).trigger('change');
                }
            }
        });

        // اجرای اولیه
        if ([...params.keys()].some(k => k.startsWith('debit_'))) {
            filterDebits();
        }
        if ([...params.keys()].some(k => k.startsWith('credit_'))) {
            filterCredits();
        }
    }

    // بار اول
    fillFormsFromUrl();

    // هندل تغییرات فرم‌ها
    $('#debit-filter-form input, #debit-filter-form select').on('input change keyup', filterDebits);
    $('#credit-filter-form input, #credit-filter-form select').on('input change keyup', filterCredits);

    // back/forward مرورگر
    window.onpopstate = function () {
        fillFormsFromUrl();
    };
});

$(document).ready(function () {

    // فعال کردن تب بر اساس URL
    function activateTabFromUrl() {
        const params = new URLSearchParams(window.location.search);
        const tab = params.get('tab');

        if (tab === 'credit') {
            const creditTab = new bootstrap.Tab($('#pills-credit-tab'));
            creditTab.show();
        } else {
            // پیش‌فرض تب بدهی
            const debitTab = new bootstrap.Tab($('#pills-debit-tab'));
            debitTab.show();
        }
    }

    // بایند کردن تغییر تب برای آپدیت URL
    $('button[data-bs-toggle="pill"]').on('shown.bs.tab', function (e) {
        const target = $(e.target).attr('data-bs-target'); // #debits یا #credits
        const params = new URLSearchParams(window.location.search);

        if (target === '#debits') {
            params.set('tab', 'debit');
        } else if (target === '#credits') {
            params.set('tab', 'credit');
        }

        const newUrl = window.location.pathname + '?' + params.toString();
        window.history.pushState({}, '', newUrl);
    });

    // هنگام load صفحه
    activateTabFromUrl();

    // Back/Forward مرورگر
    window.onpopstate = function () {
        activateTabFromUrl();
    };
});

$('#change-cheque-status').each(function() {
    const currentUrl = window.location.href;
    const href = $(this).attr('href');
    const separator = href.includes('?') ? '&' : '?';
    $(this).attr('href', href + separator + 'next=' + encodeURIComponent(currentUrl));
});
    </script>
{% endblock %}