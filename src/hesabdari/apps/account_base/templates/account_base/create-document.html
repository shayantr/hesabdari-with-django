{% extends 'base.html' %}
{% load static %}
{% block header %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AJAX Input in Django</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link type="text/css" rel="stylesheet" href="{% static 'js/jalalidatepicker.min.css' %}" />
    <script type="text/javascript" src="{% static 'js/jalalidatepicker.min.js' %}"></script>
    
    
        <style>
        .form-wrapper {
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
        }
    </style>
    <style>
        ul { list-style-type: none; }
        .toggle {
            cursor: pointer;
            font-weight: bold;
            margin-right: 5px;
        }
        .children {
            display: none;
            margin-left: 20px;
        }
    </style>
    
{% endblock %}
{% block body %}
<form id="mainForm" enctype="multipart/form-data" class="form-floating mb-0">
        {% csrf_token %}
        <div id="forms-container">
        <div class="debt">
            {% for i in combined_forms %}
                {% if i.form_balance.transaction_type.value == "debt" %}
                    <div class="form-wrapper" id="{{ i.uniqueid }}">
    <div class="remove-form" style="color:red; cursor:pointer;">Ø­Ø°Ù</div>
    <div class="border rounded p-3">
        {{ i.form_balance.user }}
         
        {{ i.form_balance.account }}
        <h5 id="{{ i.uniqueid }}-accounts-list"></h5>
        <input type="hidden" id="{{ i.uniqueid }}-accounts-list">
        <div class="modal fade" id="{{ i.uniqueid }}-accounts-lists" data-bs-keyboard="false" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="collapse multi-collapse show">
                            <h5 class="mb-0">Ø§Ù†ØªØ®Ø§Ø¨ Ø­Ø³Ø§Ø¨</h5>
                        </div>
                    </div>
                    <div class="modal-body">
                    </div>
                    <div class="modal-footer justify-content-between collapse multi-collapse show">
                        <div class="flex-grow-1 text-end">
                            <button type="button" class="btn btn-link-danger" data-bs-dismiss="modal">Ù„ØºÙˆ</button>
                            <button type="button" id="select-account-{{ i.uniqueid }}" class="btn btn-primary" data-bs-dismiss="modal">Ø°Ø®ÛŒØ±Ù‡</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <button type="button"
            class="btn btn-sm btn-light-secondary" data-bs-toggle="modal" 
            data-bs-target="#{{ i.uniqueid }}-accounts-lists"
            id="{{ i.uniqueid }}-accounts-list">
            <i class="ph-duotone ph-pencil-simple-line"></i> ØªØºÛŒÛŒØ±
        </button>
    </div>
    {{ i.form_balance.transaction_type }}
    <div class="cashonly input-group mb-3">
        <div class="input-group mb-3">
            {{ i.form_balance.amount }}
            <span class="input-group-text">ØªÙˆÙ…Ø§Ù†</span>  
        </div>
    </div>
    <div class="mb-0">
        <div class="form-control">{{ i.form_balance.description }}</div>
    </div>
    <div class="mb-3">
        <label class="form-label">{{ i.form_balance.image.label }}</label>
        {% if i.form_balance.image.value %}
            <img src="{{ i.form_balance.image.value.url }}" width="150px">
        {% endif %}
        {{ i.form_balance.image }}
    </div>
    <label>
        <input type="checkbox" class="toggle-cheque-form" {% if i.form_cheque.name.value == None %}{% else %}checked id="{{ i.chequeid }}"{% endif %}/>
        Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú†Ú©
    </label>
    <div class="cheque-form border rounded p-3 h-100 text-white bg-info" style="display: {% if i.form_cheque.name.value == None %}none{% else %}block{% endif %}; margin-top: 10px;">
        {{ i.form_cheque }}
        <div class="remove-cheque" {% if i.form_cheque.name.value == None %}none{% else %}block{% endif %} style="margin-top: 1%">
            <button type="button" data-chequeid="{{ i.chequeid }}" class="delete-cheque-btn" style="color:red">Ø­Ø°Ù</button>
        </div>

    </div>
<script>
        $('#select-account-{{ i.uniqueid }}').click(function () {
            const $form = $(this);
            const $context = $(this).closest('.modal');
            // 2. Ø­Ø³Ø§Ø¨Ù Ø§Ù†ØªØ®Ø§Ø¨â€‘Ø´Ø¯Ù‡ Ø¯Ø± Ù‡Ù…Ø§Ù† Ø¯Ø±Ø®Øª
            const $checked = $context.find('input[name="names"]:checked');
    
            if ($checked.length === 0) {
                alert('Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ø­Ø³Ø§Ø¨ Ø±Ø§ Ø§Ø² Ø¯Ø±Ø®Øª Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.');
                return;
            }
            const accId   = $checked.val();
            const accName = $.trim($checked[0].nextSibling.nodeValue);
            {#const $select = $("select[id$='{{ uniqueid }}-new-balance-account']");#}
            const $wrapper   = $form.closest('.form-wrapper');
            const $select = $wrapper.find('[id$="-balance-account"]').first();
    
            // Ø§Ú¯Ø± Ú¯Ø²ÛŒÙ†Ù‡ Ù‡Ù†ÙˆØ² ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ØŒ Ø¨Ø³Ø§Ø²
            if (!$select.find(`option[value="${accId}"]`).length) {
                $select.append(`<option value="${accId}">${accName}</option>`);
            }
    
            // 4. Ø§Ù†ØªØ®Ø§Ø¨ Ùˆ Ø§Ø¹Ù„Ø§Ù… ØªØºÛŒÛŒØ±
            $select.val(accId).trigger('change');
        });
</script>
</div>
                    {% endif %}
            {% endfor %}
            <p>---------Ø¨Ø¯Ù‡ÛŒ Ù‡Ø§--------</p>
        </div>
        <button type="button" id="add-form-debt">Ø§ÙØ²ÙˆØ¯Ù† ÙØ±Ù… Ø¨Ø¯Ù‡ÛŒ</button>
        <p>---------Ø¨Ø¯Ù‡ÛŒ--------</p>
        <p>---------Ø¨Ø³ØªØ§Ù†Ú©Ø§Ø±ÛŒ------</p>
            <div class="credit">
                            {% for i in combined_forms %}
                {% if i.form_balance.transaction_type.value == "credit" %}
                    <div class="form-wrapper" id="{{ i.uniqueid }}">
    <div class="remove-form" style="color:red; cursor:pointer;">Ø­Ø°Ù</div>
    <div class="border rounded p-3">
        {{ i.form_balance.user }}
        <label class="form-label">{{ i.form_balance.account.label }}</label>
        {{ i.form_balance.account }}
        <h5 id="{{ i.uniqueid }}-accounts-list"></h5>
        <input type="hidden" id="{{ i.uniqueid }}-accounts-list">
        <div class="modal fade" id="{{ i.uniqueid }}-accounts-lists" data-bs-keyboard="false" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="collapse multi-collapse show">
                            <h5 class="mb-0">Ø§Ù†ØªØ®Ø§Ø¨ Ø­Ø³Ø§Ø¨</h5>
                        </div>
                    </div>
                    <div class="modal-body">
                    </div>
                    <div class="modal-footer justify-content-between collapse multi-collapse show">
                        <div class="flex-grow-1 text-end">
                            <button type="button" class="btn btn-link-danger" data-bs-dismiss="modal">Ù„ØºÙˆ</button>
                            <button type="button" id="select-account-{{ i.uniqueid }}" class="btn btn-primary" data-bs-dismiss="modal">Ø°Ø®ÛŒØ±Ù‡</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <button type="button"
            class="btn btn-sm btn-light-secondary" data-bs-toggle="modal" 
            data-bs-target="#{{ i.uniqueid }}-accounts-lists"
            id="{{ i.uniqueid }}-accounts-list">
            <i class="ph-duotone ph-pencil-simple-line"></i> ØªØºÛŒÛŒØ±
        </button>
    </div>
    {{ i.form_balance.transaction_type }}
    <div class="cashonly input-group mb-3">
        <div class="input-group mb-3">
            {{ i.form_balance.amount }}
            <span class="input-group-text">ØªÙˆÙ…Ø§Ù†</span>  
        </div>
    </div>
    <div class="mb-0">
        <div class="form-control">{{ i.form_balance.description }}</div>
    </div>
    <div class="mb-3">
        <label class="form-label">{{ i.form_balance.image.label }}</label>
        {% if i.form_balance.image.value %}
            <img src="{{ i.form_balance.image.value.url }}" width="150px">
        {% endif %}
        {{ i.form_balance.image }}
    </div>
    <label>
        <input type="checkbox" class="toggle-cheque-form" {% if i.form_cheque.name.value == None %}{% else %}checked id="{{ i.chequeid }}"{% endif %} />
        Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú†Ú©
    </label>
    <div class="cheque-form border rounded p-3 h-100 text-white bg-info" style="display: {% if i.form_cheque.name.value == None %}none{% else %}block{% endif %}; margin-top: 10px;">
        {{ i.form_cheque }}
    </div>
<script>
        $('#select-account-{{ i.uniqueid }}').click(function () {
            const $form = $(this);
            const $context = $(this).closest('.modal');
            // 2. Ø­Ø³Ø§Ø¨Ù Ø§Ù†ØªØ®Ø§Ø¨â€‘Ø´Ø¯Ù‡ Ø¯Ø± Ù‡Ù…Ø§Ù† Ø¯Ø±Ø®Øª
            const $checked = $context.find('input[name="names"]:checked');
    
            if ($checked.length === 0) {
                alert('Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ø­Ø³Ø§Ø¨ Ø±Ø§ Ø§Ø² Ø¯Ø±Ø®Øª Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.');
                return;
            }
            const accId   = $checked.val();
            const accName = $.trim($checked[0].nextSibling.nodeValue);
            {#const $select = $("select[id$='{{ uniqueid }}-new-balance-account']");#}
            const $wrapper   = $form.closest('.form-wrapper');
            const $select = $wrapper.find('[id$="-balance-account"]').first();
    
            // Ø§Ú¯Ø± Ú¯Ø²ÛŒÙ†Ù‡ Ù‡Ù†ÙˆØ² ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ØŒ Ø¨Ø³Ø§Ø²
            if (!$select.find(`option[value="${accId}"]`).length) {
                $select.append(`<option value="${accId}">${accName}</option>`);
            }
    
            // 4. Ø§Ù†ØªØ®Ø§Ø¨ Ùˆ Ø§Ø¹Ù„Ø§Ù… ØªØºÛŒÛŒØ±
            $select.val(accId).trigger('change');
        });
</script>
</div>
                    {% endif %}
            {% endfor %}
            </div>
            <button type="button" id="add-form-credit">Ø§ÙØ²ÙˆØ¯Ù† ÙØ±Ù… Ø¨Ø³ØªØ§Ù†Ú©Ø§Ø±ÛŒ</button>
        <p>---------Ø¨Ø³ØªØ§Ù†Ú©Ø§Ø±ÛŒ------</p>
        </div>
            <div class="col-12">
                <div class="invoice-total ms-auto">
                    <div class="row">
                        <div class="col-6">Ø¬Ù…Ø¹ Ø¨Ø¯Ù‡Ú©Ø§Ø±ÛŒ</div>
                        <div class="col-6 debt-sum"><p class="f-w-600 mb-1 text-end text-danger" id="text-debt">aa</p></div>
                        <div class="col-6">Ø¬Ù…Ø¹ Ø¨Ø³ØªØ§Ù†Ú©Ø§Ø±ÛŒ</div>
                        <div class="col-6 credit-sum"><p class="f-w-600 mb-1 text-end text-success" id="text-credit"></p></div>
                    </div>
                </div>
            </div>
            <button class="btn btn-primary me-2" id="saveall" type="submit">Ø°Ø®ÛŒØ±Ù‡ Ù‡Ù…Ù‡</button>
        </form>

<script>
jalaliDatepicker.startWatch();

function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;

}
$('#mainForm').on('submit', function (e) {
        e.preventDefault();
        let csrfToken = getCSRFToken(); // Get CSRF token
        let formData = new FormData(this);
        let url = "{{ form_action_url }}";

		$.ajax({
			url: url,
			type: "POST",
            data: formData,
            contentType: false,
            processData: false,
			headers: { "X-CSRFToken": csrfToken }, // Send CSRF token in headers
			{#data: $(this).serialize(),#}
			success: function (response) {
                if (response.success) {
                    const redirect_page = response.redirect_url || "/";
                    window.location.href = redirect_page;
                }else {
                    alert("Ø®Ø·Ø§: " + JSON.stringify(response.errors));
                }
			} 
		});
    });
$(document).ready(function () {
    function calcDebtTotal () {
    let sum = 0
    $('.debt :input[id$="-balance-amount"]').each(function () {
      sum += parseInt($(this).val()) || 0;
    });
    $('#text-debt').text(sum);
    }

    // Ù…Ø­Ø§Ø³Ø¨Ù‡Ù” Ø§ÙˆÙ„ÛŒÙ‡
    calcDebtTotal();

  // Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù† Ø²Ù†Ø¯Ù‡ Ø¨Ù‡ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ input Ùˆ change Ø±ÙˆÛŒ Ù‡Ù…Ø§Ù† Ø³Ù„Ú©ØªÙˆØ±
  $(document).on('input change', '.debt :input[id$="-balance-amount"]', calcDebtTotal);

      function calcCreditTotal () {
    let sum = 0
    // Ù‡Ù…Ù‡Ù” inputâ€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ø®Ù„ .debt (Ø¯Ø± Ù‡Ø± Ø¹Ù…Ù‚) Ú©Ù‡ Ú©Ù„Ø§Ø³Ø´Ø§Ù† Ø¨Ø§ -balance-amount ØªÙ…Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯
    $('.credit :input[id$="-balance-amount"]').each(function () {
      sum += parseInt($(this).val()) || 0;
    });
    $('#text-credit').text(sum);
    }

    // Ù…Ø­Ø§Ø³Ø¨Ù‡Ù” Ø§ÙˆÙ„ÛŒÙ‡
    calcCreditTotal();

  // Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù† Ø²Ù†Ø¯Ù‡ Ø¨Ù‡ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ input Ùˆ change Ø±ÙˆÛŒ Ù‡Ù…Ø§Ù† Ø³Ù„Ú©ØªÙˆØ±
  $(document).on('input change', '.credit :input[id$="-balance-amount"]', calcCreditTotal);
  
    $('#add-form-debt').click(function () {
        let csrfToken = getCSRFToken(); // Get CSRF token
        let transaction_type = 'debt'
        const lastForm = $('#forms-container .debt .form-wrapper').last();
        const Cheque_numbder = parseInt(lastForm.find('[name$="-Cheque_numbder"]').val());
        const maturity_date = lastForm.find('[name$="-maturity_date"]').val();
        const balance_account = lastForm.find('[name$="-balance-account"]').val();
        const amount = lastForm.find('[name$="-balance-amount"]').val();
		$.ajax({
			url: "{% url 'get_form_fragment' %}",
			type: "POST",
			{#headers: { "X-CSRFToken": csrfToken }, // Send CSRF token in headers#}
			data: {csrfmiddlewaretoken: csrfToken, transaction_type: transaction_type, maturity_date: maturity_date },
			success: function (response) {
                const $newForm = $(response.form_html);
                const datease = response.datease;
                const $lastForm = $('#forms-container .debt .form-wrapper').last();
                $newForm.find(`[name$="-balance-account"]`).val(balance_account);
                $newForm.find(`[name$="-balance-amount"]`).val(amount);
                
                if ($lastForm.length) {
                    const wasChecked = $lastForm.find('.toggle-cheque-form').is(':checked');
                    if (wasChecked) {
                        $newForm.find('.toggle-cheque-form').prop('checked', true); // ØªÛŒÚ© Ø²Ø¯Ù†
                        $newForm.find('.cheque-form').show(); // Ù†Ù…Ø§ÛŒØ´ ÙØ±Ù… Ú†Ú©
                        $newForm.find(`[name$="-Cheque_numbder"]`).val(Cheque_numbder+1);
                        $newForm.find(`[name$="-maturity_date"]`).val(datease);
                        const chequeFields = ['name', 'bank_name'];
                        chequeFields.forEach(field => {
                            const val = lastForm.find(`[name$="-${field}"]`).val();
                            $newForm.find(`[name$="-${field}"]`).val(val);
                        });
                    }
                }
				$('.debt').append($newForm);
                calcDebtTotal();

			}
		});
    });
    $('#add-form-credit').click(function () {
        let csrfToken = getCSRFToken(); // Get CSRF token
        let transaction_type = 'credit'
        const lastForm = $('#forms-container .credit .form-wrapper').last();
        const Cheque_numbder = parseInt(lastForm.find('[name$="-Cheque_numbder"]').val());
        const maturity_date = lastForm.find('[name$="-maturity_date"]').val();
        const balance_account = lastForm.find('[name$="-balance-account"]').val();
        const amount = lastForm.find('[name$="-balance-amount"]').val();

		$.ajax({
			url: "{% url 'get_form_fragment' %}",
			type: "POST",
			{#headers: { "X-CSRFToken": csrfToken }, // Send CSRF token in headers#}
			data: {csrfmiddlewaretoken: csrfToken, transaction_type: transaction_type, maturity_date: maturity_date},
			success: function (response) {
                const $newForm = $(response.form_html);
                const $lastForm = $('#forms-container .credit .form-wrapper').last();
                $newForm.find(`[name$="-balance-account"]`).val(balance_account);
                $newForm.find(`[name$="-balance-amount"]`).val(amount);

                const datease = response.datease;
                if ($lastForm.length) {
                    const wasChecked = $lastForm.find('.toggle-cheque-form').is(':checked');
                    if (wasChecked) {
                        $newForm.find('.toggle-cheque-form').prop('checked', true); // ØªÛŒÚ© Ø²Ø¯Ù†
                        $newForm.find('.cheque-form').show(); // Ù†Ù…Ø§ÛŒØ´ ÙØ±Ù… Ú†Ú©
                        $newForm.find(`[name$="-Cheque_numbder"]`).val(Cheque_numbder+1);
                        $newForm.find(`[name$="-maturity_date"]`).val(datease);
                        const chequeFields = ['name', 'bank_name'];
                        chequeFields.forEach(field => {
                            const val = lastForm.find(`[name$="-${field}"]`).val();
                            $newForm.find(`[name$="-${field}"]`).val(val);
                        });
                    }
                }
				$('.credit').append($newForm);
                calcCreditTotal();



			}
		});
    });

    $('#forms-container').on('click', '.remove-form', function () {
        $(this).closest('.form-wrapper').remove();
        calcDebtTotal();
        calcCreditTotal();

    });
    $('#forms-container').on('change', '.toggle-cheque-form', function () {
    const chequeForm = $(this).closest('.form-wrapper').find('.cheque-form');
    if ($(this).is(':checked')) {
        chequeForm.show();
    } else {
        chequeForm.hide();
        chequeForm.find('input, textarea, select').val('');
        chequeForm.find('select').prop('selectedIndex', 0); // Ø¨Ø±Ø§ÛŒ selectâ€ŒÙ‡Ø§
    }
});
    
    

});

$(document).ready(function () {

    $('[id$="-accounts-list"]').click(function () {
        let csrfToken = getCSRFToken(); // Get CSRF token

		$.ajax({
			url: "{% url 'get_accounts_list' %}",
			type: "GET",
			{#headers: { "X-CSRFToken": csrfToken }, // Send CSRF token in headers#}
			data: {csrfmiddlewaretoken: csrfToken },
			success: function (response) {
                const $newForm = $(response.form_html);
                $('.modal-body').html($newForm);

			}
		});
    });
});


$(document).ready(function() {
    $('.delete-cheque-btn').on('click', function() {
        var chequeId = $(this).data('chequeid');  // ÙÙ‚Ø· Ù‡Ù…ÙˆÙ†ÛŒ Ú©Ù‡ Ú©Ù„ÛŒÚ© Ø´Ø¯
        var button = $(this);  // Ø¨Ø±Ø§ÛŒ Ø­Ø°Ù ÛŒØ§ ØªØºÛŒÛŒØ± Ù…ØªÙ† Ø¨Ø¹Ø¯ Ø§Ø² Ù…ÙˆÙÙ‚ÛŒØª
        var formWrapper = button.closest('.form-wrapper');
        var chequeForm = button.closest('.cheque-form');

        $.ajax({
            url: '{% url "delete-cheque-view" %}',
            type: 'POST',
            data: {
                'cheque_id': chequeId,
                'csrfmiddlewaretoken': '{{ csrf_token }}',
            },
            success: function(response) {
                if (response.success) {
                    alert('Ú†Ú© Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯');
                    button.remove();
                    formWrapper.find('.toggle-cheque-form').prop('checked', false);
                    chequeForm.hide();
                    chequeForm.find('input, textarea, select').val('');
                    chequeForm.find('select').prop('selectedIndex', 0); // Ø¨Ø±Ø§ÛŒ selectâ€ŒÙ‡Ø§
                
                    
                } else {
                    alert('Ø®Ø·Ø§: ' + response.error);
                }
            }
        });
    });
});


// Ø¨Ø§Ø² Ùˆ Ø¨Ø³ØªÙ‡ Ú©Ø±Ø¯Ù† Ø¯Ø±Ø®Øª
document.addEventListener('click', function (e) {
    if (e.target.classList.contains('toggle')) {
        const children = e.target.closest('li').querySelector('.children');
        if (children) {
            const isOpen = children.style.display === 'block';
            children.style.display = isOpen ? 'none' : 'block';
            e.target.textContent = isOpen ? 'â–¶' : 'â–¼';
        }
    }
});

$(document).ready(function () {
    // add node to tree
    function addAccountToTree(id, name, parentId, $formContext) {
        const $newLi = $(`
            <li>
                <input class="form-check-input" type="radio" name="names" value="${id}" checked>
                <span class="account-name" data-id="${id}">${name}</span>
                <button type="button" class="btn-edit-account btn btn-sm" data-id="${id}">ğŸ“</button>
                <button type="button" class="btn-delete-account btn btn-sm" data-id="${id}">â– </button>
                <button type="button" class="btn-add-child btn btn-sm" data-parent-id="${id}">â•</button>

                <ul class="children" style="display: none;"></ul>
            </li>
        `);

        if (parentId) {
            const $parentRadio = $(`input[name="names"][value="${parentId}"]`);
            const $parentLi = $parentRadio.closest('li');

            let $childrenContainer = $parentLi.children('ul.children');
            if (!$childrenContainer.length) {
                $childrenContainer = $('<ul class="children" style="display: none;"></ul>');
                $parentLi.append($childrenContainer);
            }

            if ($parentLi.find('> .toggle').length === 0) {
                const $toggle = $('<span class="toggle">â–¶</span>');
                $parentLi.prepend($toggle);
            }

            $childrenContainer.append($newLi).slideDown();
        } else {
            const $treeContainer = $formContext.closest('.collapse, .modal').find('ul').first();
            $treeContainer.append($newLi);
        }

        $newLi.find('input[type=radio]').prop('checked', true);
    }

    // cancell edit button
    function closeEditMode($li, id) {
        $li.find('.edit-account-input, .btn-save-edit, .btn-cancel-edit').remove();
        $li.find(`.account-name[data-id="${id}"]`).show();
        $li.find(`.btn-edit-account[data-id="${id}"], .btn-delete-account[data-id="${id}"]`).show();
    }

    // edit button
    $(document).on('click', '.btn-edit-account', function () {
        const id = $(this).data('id');
        const $li = $(this).closest('li');
        const $span = $li.find(`.account-name[data-id="${id}"]`);
        const name = $span.text().trim();

        $('.edit-account-input').each(function () {
            const $input = $(this);
            const $li = $input.closest('li');
            const id = $input.siblings('.btn-save-edit').data('id');
            closeEditMode($li, id);
        });

        const $input = $(`<input type="text" class="edit-account-input form-control d-inline w-auto me-2" value="${name}">`);
        const $save = $(`<button type="button" class="btn-save-edit btn btn-sm btn-success me-1" data-id="${id}">Ø°Ø®ÛŒØ±Ù‡</button>`);
        const $cancel = $(`<button class="btn-cancel-edit btn btn-sm btn-secondary" data-id="${id}">Ù„ØºÙˆ</button>`);

        $span.hide().after($input).after($save).after($cancel);
        $(this).hide();
        $li.find(`.btn-delete-account[data-id="${id}"]`).hide();
    });

    // save edit button
    $(document).on('click', '.btn-save-edit', function () {
        const id = $(this).data('id');
        const $li = $(this).closest('li');
        const $input = $li.find('.edit-account-input');
        const newName = $input.val().trim();
        const $span = $li.find(`.account-name[data-id="${id}"]`);

        if (!newName) return Swal.fire('Ø®Ø·Ø§', 'Ù†Ø§Ù… Ø­Ø³Ø§Ø¨ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯', 'warning');

        $.ajax({
            url: "{% url 'edit_account' 0 %}".replace('0', id),
            method: 'POST',
            data: { name: newName },
            headers: { 'X-CSRFToken': getCSRFToken() },
            success: function (data) {
                if (data.success) {
                    $span.text(newName);
                    closeEditMode($li, id);
                } else {
                    Swal.fire('Ø®Ø·Ø§', 'ÙˆÛŒØ±Ø§ÛŒØ´ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯.', 'error');
                }
            }
        });
    });

    // cancel edit button
    $(document).on('click', '.btn-cancel-edit', function () {
        const id = $(this).data('id');
        closeEditMode($(this).closest('li'), id);
    });

    // delete account button
    $(document).on('click', '.btn-delete-account', function () {
        const id = $(this).data('id');
        const $li = $(this).closest('li');

        Swal.fire({
            title: "Ø­Ø°Ù Ø­Ø³Ø§Ø¨ØŸ",
            text: "Ø§ÛŒÙ† Ø¹Ù…Ù„ÛŒØ§Øª Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ³Øª!",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33",
            confirmButtonText: "Ø¨Ù„Ù‡ØŒ Ø­Ø°Ù Ú©Ù†",
            cancelButtonText: "Ù„ØºÙˆ"
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: "{% url 'delete_account' 0 %}".replace('0', id),
                    method: "POST",
                    headers: { "X-CSRFToken": getCSRFToken() },
                    success: function (data) {
                        if (data.success) {
                            const $parentUl = $li.parent('ul.children');
                             const deletedId = id;
                            $li.slideUp(300, function () {
                                $(this).remove();
                                if ($parentUl && !$parentUl.children().length) {
                                    const $parentLi = $parentUl.closest('li');
                                    $parentUl.remove();
                                    $parentLi.children('.toggle').remove();
                                }
                            });
                            $('select[name="parent"] option[value="' + deletedId + '"]').remove();
                            Swal.fire('Ø­Ø°Ù Ø´Ø¯', 'Ø­Ø³Ø§Ø¨ Ø­Ø°Ù Ø´Ø¯.', 'success');
                        } else {
                            Swal.fire('Ø®Ø·Ø§', data.error || 'Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± Ø­Ø°Ù Ø­Ø³Ø§Ø¨ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯.', 'error');
                        }
                    },
                    error: function () {
                        Swal.fire('Ø®Ø·Ø§', 'Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ± Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†Ø´Ø¯.', 'error');
                    }
                });
            }
        });
    });
// creating child account button
$(document).on('click', '.btn-add-child', function () {
    const parentId = $(this).data('parent-id');
    const $li = $(this).closest('li');
    $('.quick-add-form').remove();  // ÙÙ‚Ø· ÛŒÚ©ÛŒ ÙØ¹Ø§Ù„ Ø¨Ø§Ø´Ù‡

    const $form = $(`
        <div class="quick-add-form mt-2">
            <input type="text" class="account-name-input form-control form-control-sm d-inline-block w-50 me-2" placeholder="Ù†Ø§Ù… Ø­Ø³Ø§Ø¨">
            <button type="button" class="btn btn-sm btn-primary btn-save-account">Ø«Ø¨Øª</button>
            <button type="button" class="btn btn-sm btn-secondary btn-cancel-add">Ù„ØºÙˆ</button>
        </div>
    `);

    $li.append($form);
});

// cancell creating account button
$(document).on('click', '.btn-cancel-add', function () {
    $(this).closest('.quick-add-form').remove();
});

// save account button
$(document).on('click', '.btn-save-account', function () {
    const $form = $(this).closest('.quick-add-form');
    const name = $form.find('.account-name-input').val().trim();
    const parentId = $form.closest('li').find('.btn-add-child').data('parent-id') || "";

    if (!name) {
        Swal.fire('Ø®Ø·Ø§', 'Ù†Ø§Ù… Ø­Ø³Ø§Ø¨ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯.', 'warning');
        return;
    }

    $.ajax({
        url: "{% url 'create_accounts' %}",
        method: "POST",
        data: { name: name, parent: parentId },
        headers: { "X-CSRFToken": getCSRFToken() },
        success: function (data) {
            if (data.success) {
                addAccountToTree(data.id, data.name, data.parent_id, $form);
                $form.remove();
                $('select[name="parent"]').append(`<option value="${data.id}">${data.name}</option>`);
            } else {
                Swal.fire('Ø®Ø·Ø§', JSON.stringify(data.errors), 'error');
            }
        }
    });
});
$(document).on('click', '#btn-add-root', function () {
    $('.quick-add-form').remove();

    const $form = $(`
        <div class="quick-add-form mb-3">
            <input type="text" class="account-name-input form-control form-control-sm d-inline-block w-50 me-2" placeholder="Ù†Ø§Ù… Ø­Ø³Ø§Ø¨ Ø±ÛŒØ´Ù‡">
            <button type="button" class="btn btn-sm btn-primary btn-save-account">Ø«Ø¨Øª</button>
            <button type="button" class="btn btn-sm btn-secondary btn-cancel-add">Ù„ØºÙˆ</button>
        </div>
    `);

    $('#account-tree-container > ul').prepend($form);
});
});
    



</script>

{% endblock %}
