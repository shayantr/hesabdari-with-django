{% extends 'base.html' %}
{% load static %}
{% load jinja_filters %}
{% block header %}
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <link type="text/css" rel="stylesheet" href="{% static 'js/jalalidatepicker.min.css' %}"/>
    <script type="text/javascript" src="{% static 'js/jalalidatepicker.min.js' %}"></script>
    {% endblock %}

{% block body %}
    <h2>گزارش سند ها</h2>


        <form id="search-filter-form">
            <div class="row mb-3 p-3 rounded" style="background-color: #e7f7ec;">
                <div class="col-md-3 mb-2">
                    <input type="text" name="account_name" placeholder="جستجو نام حساب" class="form-control mb-2">
                </div>
                <div class="col-md-3 mb-2">
                    <input type="text" name="description" placeholder="جستجو در توضیحات" class="form-control mb-2">
                </div>
                <div class="col-md-3 mb-2">
                    <input type="text" name="amount" placeholder="مبلغ" class="form-control mb-2">
                </div>
                
                <div class="col-md-3 mb-2">
                    <input type="text" name="document_id" placeholder="شماره روکش" class="form-control mb-2">
                </div>
            </div>
            <!-- بخش اول: تاریخ ثبت -->
            <div class="row mb-3 p-3 rounded" style="background-color: #e8f0fe;">
                <label class="mb-2 fw-bold">تاریخ ثبت:</label>
                <div class="col-md-6 mb-2">
                    <input type="text" class="form-control" name="created_at_from" data-jdp placeholder="تاریخ ثبت از">
                </div>
                <div class="col-md-6 mb-2">
                    <input type="text" class="form-control" name="created_at_to" data-jdp placeholder="تاریخ ثبت تا">
                </div>
            </div>

        </form>
                <div id="balance-summary" class=" row bg-white shadow-md rounded-2xl p-4 mt-6 flex justify-between text-center">
                <div class="col-4">
                    <span class="font-semibold text-gray-700">جمع بدهکاری:</span>
                    <span id="total-debt" class="font-bold text-red-600">{{ total_debt|toman }}</span>
                </div>
                <div class="col-4">
                    <span class="font-semibold text-gray-700">جمع بستانکاری:</span>
                    <span id="total-credit" class="font-bold text-green-600">{{ total_credit|toman }}</span>
                </div>
                    <div class="col-4">
                    <span class="font-semibold text-gray-700">مانده:</span>
                <span id="total-balance" class="font-bold">{{ total_balance|toman }}</span>
            </div>
            
            </div>

        <div id="search-balance-list">
            {% include "partials/search_balance.html" %}
          
        </div>
        <div id="pre-balance-summary" class=" row bg-white shadow-md rounded-2xl p-4 mt-6 flex justify-between text-center">
                <div class="col-4">
                    <span class="font-semibold text-gray-700">جمع بدهکاری:</span>
                    <span id="pre-total-debt" class="font-bold text-red-600">{{ total_debt|toman }}</span>
                </div>
                <div class="col-4">
                    <span class="font-semibold text-gray-700">جمع بستانکاری:</span>
                    <span id="pre-total-credit" class="font-bold text-green-600">{{ total_credit|toman }}</span>
                </div>
                    <div class="col-4">
                    <span class="font-semibold text-gray-700">مانده:</span>
                <span id="pre-total-balance" class="font-bold">{{ total_balance|toman }}</span>
            </div>
            
            </div>
    <script src="{% static 'js/plugins/isotope.pkgd.min.js' %}"></script>
    <script src="{% static 'js/plugins/index.js' %}"></script>
    <script>
        jalaliDatepicker.startWatch();
$(document).ready(function () {
    let searchtimaout = null;
    function filterbalance() {
        clearTimeout(searchtimaout);
        searchtimaout = setTimeout(function () {
        
        let formData = $('#search-filter-form').serializeArray();
        const queryString = $.param(formData);

        // آپدیت URL بدون رفرش
        const newUrl = window.location.pathname + "?" + queryString;
        window.history.pushState({}, '', newUrl);

        $.ajax({
            url: "{% url 'filter_balance' %}",
            type: "GET",
            data: formData,
            success: function (data) {
                $('#search-balance-list').html(data.html);
                $('#pre-total-debt').text(data.pre_total_debt.toLocaleString());
                $('#pre-total-credit').text(data.pre_total_credit.toLocaleString());
                let pre_balance = data.pre_total_debt - data.pre_total_credit;
                let $pre_balanceEl = $('#pre-total-balance');
                $pre_balanceEl.text(pre_balance.toLocaleString());

                // تغییر رنگ مانده
                if (pre_balance < 0) {
                    $pre_balanceEl.removeClass('text-green-600').addClass('text-red-600');
                } else {
                    $pre_balanceEl.removeClass('text-red-600').addClass('text-green-600');
                }
                $('#total-debt').text(data.total_debt.toLocaleString());
                $('#total-credit').text(data.total_credit.toLocaleString());
                let balance = data.total_debt - data.total_credit + pre_balance;
                let $balanceEl = $('#total-balance');
                $balanceEl.text(balance.toLocaleString());

                // تغییر رنگ مانده
                if (balance < 0) {
                    $balanceEl.removeClass('text-green-600').addClass('text-red-600');
                } else {
                    $balanceEl.removeClass('text-red-600').addClass('text-green-600');
                }

            }
        });
        }, 1000);
    }

    // پر کردن فرم از روی URL
    const params = new URLSearchParams(window.location.search);
    params.forEach(function (value, key) {
        let field = $(`[name="${key}"]`);

        if (field.attr('type') === 'checkbox' || field.attr('type') === 'radio') {
            field.filter(`[value="${value}"]`).prop('checked', true);
        } else {
            field.val(value).trigger('change'); // برای select2 و datepicker هم
        }
    });

    // اجرای اولیه بر اساس URL
    if (params.toString()) {
        filterbalance();
    }

    // هندل تغییرات فرم
    $('#search-filter-form input, #search-filter-form select').on('input change keyup', function () {
        filterbalance();
    });
            

});

    </script>
    

{% endblock %}