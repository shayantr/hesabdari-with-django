{% extends 'base.html' %}
{% load static %}


{% block header %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default/style.min.css" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"></script>
<link type="text/css" rel="stylesheet" href="{% static 'js/jalalidatepicker.min.css' %}" />
<script type="text/javascript" src="{% static 'js/jalalidatepicker.min.js' %}"></script>
{% endblock %}

{% block body %}
<div class="row mb-3">
<form id="search-filter-form">

  <div class="col">
    <label for="start-date">از تاریخ:</label>
    <input type="text" data-jdp id="start-date" name="start-date" class="form-control">
  </div>
  <div class="col">
    <label for="end-date">تا تاریخ:</label>
    <input type="text" data-jdp id="end-date" name="end-date" class="form-control">
  </div>

  </form>
  <div class="col d-flex align-items-end">
    <button id="filter-btn" class="btn btn-primary w-100">فیلتر</button>
  </div>
</div>
<div id="accounts-report">
<h1>Accounts Report</h1>
</div>
<script>
    jalaliDatepicker.startWatch();

$(document).ready(function () {


    function loadTree(uniqueid) {
        $.getJSON("{% url 'get_accounts_list' %}", function (response) {

            const treeElement = $(`#${uniqueid}-accounts_tree`);
            if (!treeElement.length) return;

            const tree = treeElement.jstree(true);
            if (tree) {
                tree.settings.core.data = response.data;
                tree.refresh(true);
            } else {
                createTree(uniqueid, response.data);
            }
        });
    }

    function createTree(uniqueid, data) {
        const treeElement = $(`#${uniqueid}-accounts_tree`);
        if (!treeElement.length) return;

        $(`#${uniqueid}-add_root_btn`).hide()

        treeElement.jstree("destroy");
        treeElement.jstree({
            core: {
                data: data,
                check_callback: true,
                themes: { stripes: true }
            },
            plugins: ['wholerow', 'search'],
                }).on('ready.jstree refresh.jstree open_node.jstree', function () {
                    addControlsToNodes(uniqueid);
                    $(`#${uniqueid}-accounts_tree`).off('click', 'a.btn-edit').on('click', 'a.btn-edit', function (e) {
                        e.stopPropagation(); // جلوی کلیک روی نود رو بگیر
                        // اینجا اگر میخوای اجازه بدی لینک پیش‌فرض کار کنه، e.preventDefault() نذار
                        // یا اگر لازم داری دستی ریدایرکت کنی:
                        // window.location.href = $(this).attr('href');
                    });
                });
    }
function addControlsToNodes(uniqueid) {
    const tree = $(`#${uniqueid}-accounts_tree`).jstree(true);

    // کل نودها
    const fullNodes = tree.get_json('#');

    function flattenNodes(nodes) {
        let flat = [];
        nodes.forEach(node => {
            flat.push(node);
            if (node.children && node.children.length > 0) {
                flat = flat.concat(flattenNodes(node.children));
            }
        });
        return flat;
    }

    const nodes = flattenNodes(fullNodes);


    nodes.forEach(node => {
        // گرفتن مقدار از li_attr
        const net_total_raw = node.li_attr?.['data-net-total'] ?? 0;
const net_total = parseInt(net_total_raw, 10) || 0;

// فرمت سه‌رقمی
const formatted_total = net_total.toLocaleString("fa-IR")



        const nodeId = node.id;
        const nodeName = node.text;
        const baseUrl = "{% url 'accounts_report_detail' 0 %}";
        let url = baseUrl.replace(0, nodeId);

        const startDate = $('#start-date').val();
        const endDate = $('#end-date').val();
        url += `?created_at_from=${encodeURIComponent(startDate)}&created_at_to=${encodeURIComponent(endDate)}&account_name=${encodeURIComponent(nodeName)}&account_id=${encodeURIComponent(nodeId)}`;
        const $anchor = $(`#${uniqueid}-accounts_tree #${nodeId}_anchor`);
                // تعیین رنگ
        let colorClass = "";
        if (net_total > 0) {
            colorClass = "text-success"; // سبز
        } else if (net_total < 0) {
            colorClass = "text-danger"; // قرمز
        } else {
            colorClass = "text-muted"; // خاکستری
        }

        if (!$anchor.hasClass('editing') && $anchor.find('.btn-edit').length === 0) {
            const $buttons = $('<span class="ms-auto">')
                .append(`<span class="${colorClass}" data-uid="${uniqueid}" data-id="${nodeId}">&nbsp;(${formatted_total})</span>`)
                .append(`<a href="${url}" class="btn btn-sm btn-edit"><i class="fa fa-eye"></i></a>`)
            $anchor.append($buttons);
        }
    });
}


    $.ajax({
        url: "{% url 'get_accounts_list' %}",
        type: "GET",
        success: function (response) {
            $('#accounts-report').html(response.form_html);

            createTree('default', response.data);
            //search bank
            let to = false;
            $(`#default-jstree-search`).on('keyup', function () {
                if (to) clearTimeout(to);
                to = setTimeout(function () {
                    const query = $(`#default-jstree-search`).val();
                    $(`#default-accounts_tree`).jstree(true).search(query);
                }, 250);
            });

        }
    });
    loadTree(100000000)

    function filter_form(){
        var formData = $('#search-filter-form').serialize();
        var newUrl = "?" + formData;


        // تغییر URL مرورگر بدون رفرش
        window.history.pushState({}, '', newUrl);

        $.ajax({
        url: "{% url 'get_accounts_list' %}",
        type: "GET",
        data: formData,
        success: function(response) {
            $('#accounts-report').html(response.form_html);
            createTree('default', response.data);
        }
        });
    }
    $('#filter-btn').on('click', function() {
        filter_form();
    });

    function fillFormFromQuery() {
    var params = new URLSearchParams(window.location.search);
    params.forEach(function(value, key) {
        var $field = $(`[name="${key}"]`);
        if ($field.is(':checkbox')) {
            $field.prop('checked', true);
        } else if ($field.is(':radio')) {
            $(`[name="${key}"][value="${value}"]`).prop('checked', true);
        } else {
            $field.val(value);
        }
    });
}

// 📌 هنگام refresh یا اولین بار لود
$(document).ready(function() {
    if (window.location.search) {
        fillFormFromQuery();
        filter_form();
    }
});

// 📌 هنگام back/forward
window.addEventListener('popstate', function() {
    fillFormFromQuery();
    filter_form();
});





    });
</script>

{% endblock %}



