{% load jinja_filters %}

{% for balance in balance_lists %}
<div class="card balance-card mb-3 selectable
            {% if balance.transaction_type == 'debt' %} debt-card {% else %} credit-card {% endif %}"
     onclick="toggleHighlight(this)"
     id="balanceCard{{ balance.id }}"
     role="button"
     aria-pressed="false"
     >

    <!-- اضافه کردن نوار رنگی با pseudo-element: برای پشتیبانی بهتر، یک div کناری هم اضافه میکنیم -->
    <div style="display:flex;">
        <div style="width:6px;"
             class="{% if balance.transaction_type == 'debt' %}debt-left{% else %}credit-left{% endif %}"></div>

        <div style="flex:1;">

            <div class="balance-header">
                <div>
                    <h6 class="mb-0 fw-bold"><i class="fas fa-user-circle me-2"></i>{{ balance.account }}</h6>
                    <small class="text-muted">
                        {% if balance.transaction_type == 'debt' %}به{% else %}از{% endif %}
                        {% for people in balance.people %}
                            {{ people }}{% if not forloop.last %}, {% endif %}
                        {% endfor %}
                    </small>
                </div>

                <div class="text-end">
                    <div class="balance-amount text-dark">{{ balance.sum_b }}</div>
                    <a href="{% url 'UpdateBalanceView' balance.document.id %}" class="btn btn-sm btn-outline-secondary ms-2" title="ویرایش">
                        <i class="fas fa-pen"></i>
                    </a>
                </div>
            </div>

            {% if balance.image %}
            <div class="text-center">
                <a data-fslightbox="gallery" href="{{ balance.image.url }}">
                    <img src="{{ balance.image.url }}" alt="تصویر" class="card-thumb img-fluid">
                </a>
            </div>
            {% endif %}

            <div class="balance-info">
                <div class="badge-pill right">تاریخ:<strong>&nbsp; {{ balance.document.date_created }}</strong></div>
            {{ balance.document.date_created }}
                <div class="badge-pill">مبلغ:<strong class="{% if balance.transaction_type == 'debt' %}debt-color{% else %}text-danger{% endif %}" >{{ balance.amount|toman }}</strong> </div>
                <div class="badge-pill"><strong>مانده:</strong>&nbsp;
                    <strong class="{% if balance.running_balance < 0 %}text-danger{% else %}debt-color{% endif %}">
                        {{ balance.running_balance|toman }}
                    </strong>
                </div>
                <div class="badge-pill"> سند:{{ balance.document.id }}</div>

                <div class="badge-pill"><button class="show-more-btn" type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#collapse{{ balance.id }}"
                        aria-expanded="false"
                        aria-controls="collapse{{ balance.id }}"
                        onclick="toggleChevron(event, {{ balance.id }})">
                    <span>نمایش جزئیات</span>
                    <i id="chev{{ balance.id }}" class="fas fa-chevron-down rotate-icon"></i>
                </button></div>

            </div>

            <div class="card-body pt-0">
                <div class="collapse" id="collapse{{ balance.id }}">
                    <div class="details">
                        <p class="mb-2"><strong>چک:</strong>
                            {% if not balance.cheque %} ندارد
                            {% else %} {{ balance.cheque.cheque_status }} {% endif %}
                        </p>
                        <p class="mb-0"><strong>توضیحات:</strong> {{ balance.description }}</p>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
{% endfor %}

<script>
/* تابع toggleHighlight: مطابق درخواستت کارت رو هایلایت/آنهایلایت میکنه */
function toggleHighlight(cardEl) {
    // اگر روی المان داخلی دکمه collapse کلیک شده، نباید toggle انجام بشه.
    // به همین خاطر بررسی میکنیم اگر target یک دکمه یا لینک باشه از ادامه جلوگیری کنیم.
    // اما از آنجایی که این تابع به onclick کارت متصل است، event نداریم. پس از timeout ساده استفاده میکنیم.
    // امن‌ترین کار: فقط toggle کلاس highlighted.
    cardEl.classList.toggle('highlighted');

    // برای دسترسی: aria-pressed
    const pressed = cardEl.classList.contains('highlighted');
    cardEl.setAttribute('aria-pressed', pressed ? 'true' : 'false');
}

/* وقتی دکمه نمایش جزئیات کلیک میشه، آیکن بچرخد یا برگردد */
function toggleChevron(e, id) {
    // جلوگیری از پراپاگیشن تا onclick کارت را هم فعال نکند
    e.stopPropagation();

    const icon = document.getElementById('chev' + id);
    // تا وقتی bootstrap collapse کار کنه، بعد از کوتاهی کلاس رو toggle کن
    setTimeout(() => {
        icon.classList.toggle('rotated');
    }, 10);
}

/* OPTIONAL: اگر میخوای حالت پیش‌فرض (مثلاً هایلایت شدن با کلیک دوباره) پیچیده‌تر باشه،
   میشه اینجا رفتارهای بیشتری اضافه کرد (مثلاً فقط یک کارت در لیست هایلایت باشه).
*/
</script>