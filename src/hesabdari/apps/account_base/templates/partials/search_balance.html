{% load jinja_filters %}

<div class="table-responsive" style="max-height: 70vh; overflow-y: auto;">
  <table class="table table-sm align-middle text-center">
    <thead class="table-light sticky-top">
      <tr>
        <th scope="col" class="sticky-top bg-light">سند</th>
        <th scope="col" class="sticky-top bg-light">تاریخ</th>
        <th scope="col" class="sticky-top bg-light">مبلغ</th>
        <th scope="col" class="sticky-top bg-light"></th>
      </tr>
    </thead>
    <tbody>
      {% for balance in balance_lists %}
      <tr class="toggle-row cursor-pointer"
          data-bs-toggle="collapse"
          data-bs-target="#details-{{ balance.id }}"
          aria-expanded="false"
          aria-controls="details-{{ balance.id }}"
          {% if balance.transaction_type == 'debt' %}
            style="background-color: #fff5f5;"
          {% else %}
            style="background-color: #f5fff7;"
          {% endif %}>
        
        <!-- سند -->
        <td>
          <a class="edit-balance text-decoration-none fw-semibold"
             href="{% url 'UpdateBalanceView' balance.document.id %}">
             {{ balance.document.id }}
          </a>
        </td>

        <!-- تاریخ -->
        <td class="small">{{ balance.document.date_created }}</td>

        <!-- مبلغ -->
        <td class="fw-bold text-success">{{ balance.amount|toman }}</td>

        <!-- آیکون -->
        <td class="toggle-icon text-muted">
          <i class="fas fa-chevron-down"></i>
        </td>
      </tr>

      <!-- ردیف جزئیات -->
      <tr class="collapse bg-light" id="details-{{ balance.id }}">
        <td colspan="4" class="text-start p-3">
          <div class="row g-2 small">
            <div class="col-12">
              <strong>حساب:</strong>
              <i class="fas fa-user-circle me-1"></i>{{ balance.account }}
            </div>
            
            <div class="col-12">
              <strong>چک:</strong>
              {% if not balance.cheque %}
                <span class="badge bg-secondary">ندارد</span>
              {% else %}
                <span class="badge bg-info">{{ balance.cheque.cheque_status }}</span>
              {% endif %}
            </div>
            
            {% if balance.image %}
            <div class="col-12">
              <strong>تصویر:</strong>
              <a class="card-gallery" data-fslightbox="gallery" href="{{ balance.image.url }}">
                <img src="{{ balance.image.url }}" alt="img"
                     class="rounded mt-1 shadow-sm" style="width:70px;height:70px;object-fit:cover;">
              </a>
            </div>
            {% endif %}

            {% if balance.description %}
            <div class="col-12">
              <strong>توضیحات:</strong>
              <span>{{ balance.description }}</span>
            </div>
            {% endif %}
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
  // تغییر آیکون هنگام باز/بسته شدن جزئیات
  document.querySelectorAll('.toggle-row').forEach(row => {
    row.addEventListener('click', function () {
      const icon = this.querySelector('.toggle-icon i');
      if (icon.classList.contains('fa-chevron-down')) {
        icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
      } else {
        icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
      }
    });
  });
</script>







        <script>
        $('.edit-balance').each(function () {
            const currentUrl = window.location.href;
            const href = $(this).attr('href');
            const separator = href.includes('?') ? '&' : '?';
            $(this).attr('href', href + separator + 'next=' + encodeURIComponent(currentUrl));
        });
    </script>